# ğŸš€ Async AI Task Runner - Docker Composeé…ç½®
# å¤šæœåŠ¡ç¼–æ’ï¼šWebåº”ç”¨ã€Workerã€PostgreSQLã€Redisã€Flowerç›‘æ§
services:
  # ğŸ—„ï¸ PostgreSQLæ•°æ®åº“æœåŠ¡
  postgres:
    image: postgres:16-alpine
    container_name: async_ai_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: task_runner
      POSTGRES_USER: taskuser
      POSTGRES_PASSWORD: taskpass
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      # æŒä¹…åŒ–PostgreSQLæ•°æ®
      - postgres_data:/var/lib/postgresql/data
      # åˆå§‹åŒ–è„šæœ¬ï¼ˆå¯é€‰ï¼‰
      - ./docker/postgres/init:/docker-entrypoint-initdb.d
    ports:
      # æš´éœ²PostgreSQLç«¯å£åˆ°ä¸»æœºï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
      - "5433:5432"
    networks:
      - async_ai_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U taskuser -d task_runner"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "com.docker.compose.service=postgres"
      - "project=async-ai-task-runner"

  # ğŸ”´ Redisç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡
  redis:
    image: redis:7-alpine
    container_name: async_ai_redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      # æŒä¹…åŒ–Redisæ•°æ®
      - redis_data:/data
      # Redisé…ç½®æ–‡ä»¶
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      # æš´éœ²Redisç«¯å£åˆ°ä¸»æœºï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
      - "6379:6379"
    networks:
      - async_ai_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "com.docker.compose.service=redis"
      - "project=async-ai-task-runner"

  # ğŸŒ FastAPI Webåº”ç”¨æœåŠ¡
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: async_ai_web
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # æ•°æ®åº“é…ç½®
      DATABASE_URL: postgresql+asyncpg://taskuser:taskpass@postgres:5432/task_runner

      # Redisé…ç½®
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2

      # åº”ç”¨é…ç½®
      SECRET_KEY: ${SECRET_KEY:-your-super-secret-key-change-this-in-production}
      DEBUG: ${DEBUG:-false}
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # AIæœåŠ¡é…ç½®
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # CORSé…ç½®
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:8000,http://localhost:3000}

      # æ—¥å¿—çº§åˆ«
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      # æš´éœ²FastAPIç«¯å£
      - "8000:8000"
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ï¼ˆå¼€å‘ç¯å¢ƒçƒ­é‡è½½ï¼‰
      - ./app:/app/app
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - async_ai_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.docker.compose.service=web"
      - "project=async-ai-task-runner"

  # âš™ï¸ Celery WorkeræœåŠ¡
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: async_ai_worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # æ•°æ®åº“é…ç½®
      DATABASE_URL: postgresql+asyncpg://taskuser:taskpass@postgres:5432/task_runner

      # Redisé…ç½®
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2

      # åº”ç”¨é…ç½®
      SECRET_KEY: ${SECRET_KEY:-your-super-secret-key-change-this-in-production}
      DEBUG: ${DEBUG:-false}
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # AIæœåŠ¡é…ç½®
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # Workeré…ç½®
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-4}
      WORKER_PREFETCH_MULTIPLIER: ${WORKER_PREFETCH_MULTIPLIER:-1}
      WORKER_MAX_TASKS_PER_CHILD: ${WORKER_MAX_TASKS_PER_CHILD:-1000}

      # æ—¥å¿—çº§åˆ«
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      # æŒ‚è½½ä»£ç ç›®å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
      - ./app:/app/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - async_ai_network
    deploy:
      resources:
        # é™åˆ¶Workerçš„èµ„æºä½¿ç”¨
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    labels:
      - "com.docker.compose.service=worker"
      - "project=async-ai-task-runner"

  # ğŸŒº Flowerç›‘æ§æœåŠ¡ (å¯é€‰)
  flower:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: async_ai_flower
    restart: unless-stopped
    environment:
      # Redisé…ç½®
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2

      # Floweré…ç½®
      FLOWER_BASIC_AUTH_USER: ${FLOWER_USER:-admin}
      FLOWER_BASIC_AUTH_PASSWORD: ${FLOWER_PASSWORD:-admin123}
    ports:
      # æš´éœ²Flowerç›‘æ§ç«¯å£
      - "5555:5555"
    depends_on:
      - redis
      - worker
    networks:
      - async_ai_network
    command: ["uv", "run", "celery", "-A", "app.worker.app", "flower", "--port=5555"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.docker.compose.service=flower"
      - "project=async-ai-task-runner"

# ğŸ“ æ•°æ®å·å®šä¹‰
volumes:
  postgres_data:
    driver: local
    labels:
      - "project=async-ai-task-runner"

  redis_data:
    driver: local
    labels:
      - "project=async-ai-task-runner"

# ğŸŒ ç½‘ç»œå®šä¹‰
networks:
  async_ai_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    labels:
      - "project=async-ai-task-runner"